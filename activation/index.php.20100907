<?php 
// Include web header
include(".includes/header.php");

$heading = 'Online Staff IT Account Activation';
$user = $content = '';

# Get account details from LDAP for user.
function get_ldap_data($ds)
{
   include(".includes/authusers.php");
   global $content, $user;
   $USERBASE    = 'ou=people,dc=exeter,dc=ac,dc=uk';
   $USERATRBS   = array("sn","uid","exetercollectdate","exeterstaffnumber","exeterassociatenumber","cn","mail","exeterprimaryorg","exeterprimaryorgunit","exetercollectby","exetercardnumber","exeteridf");
   $filter = "Unactivated";
   $admin = 0;
   if (isset($authstf[$user]))
   {
      $authOrgs = $authstf[$user];
      $admin = 1;
   } else
   {
      $authOrgs = $authstf["generic"];
   }
   #print_r($authOrgs); print "<BR>";
   foreach ($authOrgs as $type => $group)
   {
      foreach (split(",", $group) as $value)
      {
         $search = "(&(exeterStatus=$type)";
         if ($primaryOrg[$value] == "all") {
            $search_org = "All $type";
            if ($filter == "Activated") 
            {
               $content = '<h3><br>You cannot view all activated staff, silly!</h3>';
               return 1;
            }
         } else 
         {
            $search_org = $primaryOrg[$value];
            $safe_search = quotemeta($search_org);
            $search .= "(exeterPrimaryOrg=$safe_search)";
         }
         if ($filter == "Activated") { $search .= "(!"; }
            $search .= "(exeterCollectDate=19700101000000Z)";
         if ($admin != 1) { $search .= "(exeterIDF=$user)"; }
            $search .= ")";
         if ($filter == "Activated") { $search .= ")"; }
#print "SEARCH: $search\n";
         $sr = ldap_search($ds, $USERBASE, $search, $USERATRBS);
         $count = ldap_count_entries($ds, $sr);
#print "COUNT: $count\n";
         $title = "$filter <b>". $type ."</b> IT Accounts in <b>". $search_org ."</b>";
         if ($count == 0) 
         { 
            $content .= "<h4>No $title</h4>"; 
         } else
         {
            $content .= "<h4>$title</h4>";
            $info = ldap_get_entries($ds, $sr);
            printAccounts($info, $filter, $type);
         }
      }
   }
   // Close LDAP connection when done
   ldap_close($ds);
}

# Check LDAP array value is not null, or return empty string
function get_data($data, $index, $attr)
{
   if (isset($data[$index]["$attr"][0]))
   {
      return $data[$index]["$attr"][0];
   } else
   {
      return " ";
   }
}

// Function to filter accounts displayed
function printAccounts($data, $filter, $type) 
{
   global $content;
   $content .= "<table class=\"sortable\" border=\"1\" cellspacing=\"0\" cellpadding=\"2\"><tr><th><b>Name</b></th><th><b>E-Mail</b></th><th><b>Employee No.</b></th><th><b>UniCard No.</b></th><th><b>Collected</b></th></tr>";

    $numberAttrb = "exeterstaffnumber";
    if ($type == "Associate") { $numberAttrb = "exeterassociatenumber"; }
    for ($i = 0; $i < $data["count"]; $i++)
    {
       #$formatData[$i][0] = $data[$i]["sn"][0];
       $formatData[$i][0] = get_data($data, $i, "sn");
       $formatData[$i][1] = get_data($data, $i, "uid");
       $formatData[$i][2] = get_data($data, $i, "exetercollectdate");
       $formatData[$i][3] = get_data($data, $i, "$numberAttrb");
       $formatData[$i][4] = get_data($data, $i, "cn");
       $formatData[$i][5] = get_data($data, $i, "mail");
       $formatData[$i][6] = get_data($data, $i, "exeterprimaryorg");
       $formatData[$i][7] = get_data($data, $i, "exeterprimaryorgunit");
       $formatData[$i][8] = get_data($data, $i, "exetercollectby");
       $formatData[$i][9] = get_data($data, $i, "exetercardnumber");
    }
    sort($formatData);

    for ($i = 0; $i < count($formatData); $i++) 
    {
       $username = $collectDate = $number = $name = $email = $org = $orgUnit = $collectBy = $cardno = $collected = "&nbsp";
       $username    = $formatData[$i][1];
       $collectDate = $formatData[$i][2];
       $number      = $formatData[$i][3];
       $name        = $formatData[$i][4];
       $email       = $formatData[$i][5];
       $org         = $formatData[$i][6];
       $orgUnit     = $formatData[$i][7];
       $collectBy   = $formatData[$i][8];
       $cardno      = $formatData[$i][9];

       $cardno = substr($cardno, -9);
       if ($cardno != "") { $cardno = $cardno . "S"; }

       if ($filter == "Unactivated") 
       {
          if ($collectDate != "19700101000000Z") 
          {
             continue;
          } else 
          {
             $collected = "<form name=\"form$i\" method=\"post\" action=\"form.php\">
				<input type=\"hidden\" name=\"User\" value=\"$username\">
				<input type=\"hidden\" name=\"Name\" value=\"$name\">
				<input type=\"hidden\" name=\"Email\" value=\"$email\">
				<input type=\"hidden\" name=\"Number\" value=\"$number\">
				<input type=\"hidden\" name=\"Card\" value=\"$cardno\">
				<input type=\"submit\" name=\"Submit\" value=\"Collect Details\">
			   </form>";
          }
       }
       if ($filter == "Activated") 
       {
          if ($collectDate == "19700101000000Z") 
          {
             continue;
          } else 
          {
             if ($collectDate != "") 
             {
                $collected = substr($collectDate,6,2)."/".substr($collectDate,4,2)."/".substr($collectDate,0,4);
             }
          }
       }

   $content .= "<tr><td>$name</td><td>$email</td><td>$number</td><td>$cardno</td><td>$collected</td></tr>";
   }
   $content .= "</table><br>";
}

# This actually does the work!
if (check_access() == 0)
{
   $ds = connect_ldap();
   if (isset($ds))
   {
      get_ldap_data($ds, $user);
   }
}

modifyTemplate($site, $uri, $heading, $content);
?>
